# This GitHub Actions workflow automates the creation and deletion 
# of temporary database branches on Neon for each pull request.
#
# WHAT IT DOES:
# When a Pull Request (PR) is opened, reopened, or synchronized (updated),
# it creates a temporary Neon database branch for that PR.
# When the PR is closed, it deletes the temporary Neon branch.
# This allows every PR to have its own isolated database environment
# â€” perfect for preview deployments and testing.
# ================================================================

# The workflow name that appears in GitHub Actions
name: Create/Delete Branch for Pull Request

# Defines when this workflow should run
on:
  pull_request:                  # This triggers when a pull request event happens
    types:                       # The list of PR actions that will start this workflow
      - opened                   # When a PR is first opened
      - reopened                 # When a closed PR is reopened
      - synchronize               # When new commits are pushed to the PR
      - closed                   # When the PR is closed (to delete the Neon branch)

# Ensures that only one run per branch is active at a time
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  # This prevents race conditions by canceling any previous runs
  # for the same branch if a new one starts.

# Define the jobs (tasks) in this workflow
jobs:
  # --------------------------------------------------------------
  #  Setup Job: Gets the branch name
  # --------------------------------------------------------------
  setup:
    name: Setup
    outputs:
      branch: ${{ steps.branch_name.outputs.current_branch }}
      # Exports the current branch name as an output to be used by other jobs
    runs-on: ubuntu-latest        # Run this job on the latest Ubuntu environment
    steps:
      - name: Get branch name
        id: branch_name
        uses: tj-actions/branch-names@v8
        # Uses a prebuilt GitHub Action to get the current branch name of the PR

  # --------------------------------------------------------------
  #  Create Neon Branch Job
  # --------------------------------------------------------------
  create_neon_branch:
    name: Create Neon Branch
    outputs:
      db_url: ${{ steps.create_neon_branch_encode.outputs.db_url }}
      db_url_with_pooler: ${{ steps.create_neon_branch_encode.outputs.db_url_with_pooler }}
      # These are output variables that hold the Neon DB connection URLs
    needs: setup                  # This job depends on the "setup" job to run first
    if: |
      github.event_name == 'pull_request' && (
      github.event.action == 'synchronize'
      || github.event.action == 'opened'
      || github.event.action == 'reopened')
      # Run this job only when the PR is opened, reopened, or updated
    runs-on: ubuntu-latest        # Use Ubuntu as the environment

    steps:
      - name: Get branch expiration date as an env variable (2 weeks from now)
        id: get_expiration_date
        run: echo "EXPIRES_AT=$(date -u --date '+14 days' +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"
        # Create an environment variable called EXPIRES_AT, which sets an expiration 
        # date two weeks from now (so the Neon branch auto-expires)

      - name: Create Neon Branch
        id: create_neon_branch
        uses: neondatabase/create-branch-action@v6
        # Uses the official Neon GitHub Action to create a new database branch
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}  # The Neon project ID stored in GitHub Variables
          branch_name: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
          # The branch name format will be like: preview/pr-123-feature-branch
          api_key: ${{ secrets.NEON_API_KEY }}     # API key for authenticating with Neon, stored securely
          expires_at: ${{ env.EXPIRES_AT }}        # Sets the expiration date (from above)

      - name: Encode database URL
        id: create_neon_branch_encode
        run: |
          # Write the created Neon database URLs into GitHub Action outputs
          echo "db_url=${{ steps.create_neon_branch.outputs.database_url }}" >> "$GITHUB_OUTPUT"
          echo "db_url_with_pooler=${{ steps.create_neon_branch.outputs.database_url_with_pooler }}" >> "$GITHUB_OUTPUT"
          # These URLs can then be used by other jobs or environments

  # --------------------------------------------------------------
  #  Delete Neon Branch Job
  # --------------------------------------------------------------
  delete_neon_branch:
    name: Delete Neon Branch
    needs: setup                  # Depends on the setup job (for branch name)
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    # Only runs when a PR is closed, to clean up the Neon branch
    runs-on: ubuntu-latest        # Runs on the Ubuntu environment

    steps:
      - name: Delete Neon Branch
        uses: neondatabase/delete-branch-action@v2
        # Uses the official Neon Action to delete a database branch
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}   # Your Neon project ID from repository variables
          branch_name: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
          # Matches the same name that was used during creation
          api_key: ${{ secrets.NEON_API_KEY }}      # Secure Neon API key used for authentication
